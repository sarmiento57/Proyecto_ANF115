<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>{% block title %}Stela{% endblock %}</title>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Bootstrap CSS (CDN) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap JS (CDN) - Requerido para dropdowns y otros componentes -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- CSS de la app -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />


    <link rel="stylesheet" href="{% static 'css/base.css' %}">

    {% block css %}{% endblock %}
</head>
<body>

<aside class="sidebar bg-nord0 text-nord6 p-3 d-flex flex-column">
    <div class="brand mb-4 px-2 d-flex align-items-center">
        <img src="{% static 'img/logo.svg' %}" alt="Stela logo" style="height: 32px; margin-right: 8px;">
        <span>
            <a href="{% url 'landing' %}" class="btn btn-link fw-bold text-decoration-none" id="link-landing">
                Stela
            </a>
        </span>
    </div>

    <nav class="nav flex-column mb-3">
      <a class="nav-link text-nord6 d-flex flex-column align-items-center mb-3" href="{% url 'dashboard'%}">
          <i data-lucide="layout-dashboard" style="width:36px; height:36px;" class="mb-1" ></i>
          <span>Dashboard</span>
      </a>
      <a class="nav-link text-nord6 d-flex flex-column align-items-center mb-3" href="{% url 'ciiu_list'%}">
          <i data-lucide="book-open" class="mb-1" style="width:36px; height:36px;"></i>
          <span>Catálogos</span>
      </a>
      <a class="nav-link text-nord6 d-flex flex-column align-items-center mb-3" href="{% url 'tools'%}">
          <i data-lucide="line-chart" class="mb-1" style="width:36px; height:36px;"></i>
          <span>Herramientas</span>
      </a>
      <a class="nav-link text-nord6 d-flex flex-column align-items-center mb-3" href="{% url 'projections'%}">
          <i data-lucide="chart-candlestick" class="mb-1" style="width:36px; height:36px;"></i>
          <span>Proyecciones</span>
      </a>
    </nav>

    <div class="mt-auto">
        <div class="company-list-wrapper position-relative mb-3">
            <div class="d-flex align-items-center justify-content-between mb-2">
                <button id="btn-companies" class="btn btn-link p-0 fw-bold text-decoration-none">
                    Mis Empresas
                </button>

                <button class="btn btn-sm btn-outline-light" id="btn-add-company">
                    <a href="{% url 'crear_empresa' %}" class="text-white text-decoration-none">
                        <i data-lucide="plus" class="mb-1"></i>
                     </a>
                </button>
            </div>

            <div id="empresas-popup" class="empresas-popup-content p-2 rounded shadow-lg d-none">
                <ul id="companies" class="list-unstyled small mb-0">

                    <li class="d-flex justify-content-between align-items-center py-1 px-1">
                        {% for empresa in USER_COMPANIES %}
                            <li class="d-flex justify-content-between align-items-center py-1 px-1">
                                 <a href="#" class="company-link text-decoration-none flex-grow-1">
                                    {{ empresa.razon_social }}
                                </a>
                                <a href="{% url 'editar_empresa' nit=empresa.nit %}" class="btn btn-sm btn-edit-company">
                                     <i data-lucide="square-pen"></i>
                                </a>
                            </li>
                        {% empty %}
                            <li class="py-1 px-1 text-muted">No hay empresas.</li>
                        {% endfor %}

                </ul>
            </div>
        </div>

        <div class="mt-auto">
        <div class="profile-section">
            <div class="profile-menu-container position-relative"> <button class="btn btn-light w-100 text-start" id="btn-profile">
                    <i data-lucide="user" class="me-2"></i>
                {% if request.user.is_authenticated %}
                    {% comment %} Intenta obtener el nombre completo {% endcomment %}
                    {% if request.user.get_full_name %}
                        {{ request.user.get_full_name }}

                    {% comment %} Si no hay, muestra el nombre de usuario como fallback {% endcomment %}
                    {% else %}
                        {{ request.user.username }}
                    {% endif %}
                    {% else %}
                        Invitado
                    {% endif %}
                </button>
                <div id="profile-popup" class="profile-popup-content p-2 rounded shadow-lg d-none">
                    <ul class="list-unstyled small mb-0">
                        <li class="py-1 px-1">
                            <a href="{% url 'perfil_view' %}" class="profile-link text-decoration-none d-block">Perfil</a>
                        </li>
                        <li class="py-1 px-1">
                            <form id="logout-form" action="{% url 'logout' %}" method="post" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" class="profile-link text-decoration-none d-block text-danger" style="background:none;border:none;cursor:pointer;">
                                    Cerrar Sesión
                                </button>
                            </form>
                        </li>
                    </ul>
                </div>
                </div>
        </div>
        </div>
    </div>
</aside>

  <main class="flex-grow-1 p-4">
    {% block content %}
    <!-- Aquí se mostrará el contenido de cada página -->
    {% endblock %}
  </main>


<script src="{% static 'js/base.js' %}"></script>

<!-- Initialize Lucide -->
<script>
  lucide.createIcons();
</script>

<!-- Auto logout after inactivity -->
<script>
  let timeout;

  function resetTimer() {
    clearTimeout(timeout);
    timeout = setTimeout(() => {
      document.getElementById('logout-form').submit();
    }, 300000000); // 30 segundos
  }

  window.onload = resetTimer;
  document.onmousemove = resetTimer;
  document.onkeypress = resetTimer;
  document.onclick = resetTimer;
  document.onscroll = resetTimer;
</script>

{% block scripts %}{% endblock %}

</body>
</html>