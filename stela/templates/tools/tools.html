{% extends '../stela/base.html' %}
{% load static %}
{% load dict_extras %}

{% block title %}Herramientas financieras{% endblock title %}

{% block extra_head %}
  {# Estilos específicos para esta página #}
  <style>
    .table-sm td, .table-sm th { padding: .35rem .5rem; }
    .badge-dot { width:.6rem; height:.6rem; display:inline-block; border-radius:50%; margin-right:.3rem; }
    .dot-up   { background:#28a745; }  /* verde */
    .dot-down { background:#dc3545; }  /* rojo  */
    .dot-flat { background:#6c757d; }  /* gris  */
    #periodo-base-select:disabled, #periodo-actual-select:disabled {
      background-color: #e9ecef;
      cursor: not-allowed;
    }
  </style>
{% endblock extra_head %}


{% block content %}
<div class="container py-4">
  {% include 'partials/messages.html' %}

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h4 m-0">Herramientas financieras</h1>
  </div>

  <!-- Filtro / Parámetros -->
  <div class="card mb-4">
    <div class="card-header">Parámetros</div>
    <div class="card-body">
      <form class="row g-3" method="get" action="{% url 'tools_finanzas' %}" id="tools-form">
        <div class="col-md-3">
          <label class="form-label">Empresa</label>
          <select name="nit" id="empresa-select" class="form-select" required>
            <option value="">-- Seleccione una empresa --</option>
            {% if tiene_empresas %}
              {% for emp in empresas %}
                <option value="{{ emp.nit }}" {% if request.GET.nit == emp.nit|stringformat:"s" or empresa.nit == emp.nit %}selected{% endif %}>
                  {{ emp.razon_social }} ({{ emp.nit }})
                </option>
              {% endfor %}
            {% else %}
              <option value="" disabled>-- No hay empresas disponibles --</option>
            {% endif %}
          </select>
          {% if not tiene_empresas %}
            <small class="text-muted d-block mt-1">No tienes empresas asociadas. <a href="{% url 'crear_empresa' %}">Crea una empresa primero</a>.</small>
          {% endif %}
        </div>
        <div class="col-md-4">
          <label class="form-label">Período base</label>
          <select name="per_base" id="periodo-base-select" class="form-select">
            <option value="">-- Opcional --</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Período actual</label>
          <select name="per_act" id="periodo-actual-select" class="form-select" required>
            <option value="">-- Seleccione un período --</option>
          </select>
        </div>
        <div class="col-12 d-flex gap-2">
          <button type="submit" class="btn btn-primary">Consultar</button>
          <a class="btn btn-outline-secondary" href="{% url 'tools_finanzas' %}">Limpiar</a>
        </div>
      </form>

      {% if empresa and per_act %}
        <hr>
        <div class="small text-muted">
          <strong>Empresa:</strong> {{ empresa.razon_social|default:empresa.nit }} &middot;
          <strong>Período actual:</strong> {{ per_act }}
          {% if per_base_id %}&middot; <strong>Período base:</strong> #{{ per_base_id }}{% endif %}
          &middot; <strong>Estados:</strong> Balance General y Estado de Resultados
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Sección: Ratios y Benchmark -->
  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>Ratios (empresa) - Comparación con Promedio Histórico</span>
      {% if empresa and puede_ver_graficas %}
        <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#ratiosGraficasModal" onclick="cargarGraficasRatios('{{ empresa.nit }}')">
          Ver Gráficas
        </button>
      {% endif %}
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-bordered table-sm m-0">
          <thead class="table-light">
            <tr>
              <th>Ratio</th>
              <th class="text-end">Valor actual</th>
              <th class="text-end">Prom. histórico</th>
              <th class="text-end">Desv. estándar</th>
              <th class="text-center">Cumplimiento</th>
            </tr>
          </thead>
          <tbody>
            {% if ratios_rows %}
              {% for r in ratios_rows %}
                <tr>
                  <td>{{ r.nombre }}</td>
                  <td class="text-end">{% if r.valor is not None %}{{ r.valor|floatformat:2 }}{% else %}—{% endif %}</td>
                  <td class="text-end">{% if r.promedio is not None %}{{ r.promedio|floatformat:2 }}{% else %}—{% endif %}</td>
                  <td class="text-end">{% if r.desv is not None %}{{ r.desv|floatformat:2 }}{% else %}—{% endif %}</td>
                  <td class="text-center">
                    {% if r.semaforo == 'OK' %}
                      <span class="badge bg-success">OK</span>
                    {% elif r.semaforo == 'ALTO' %}
                      <span class="badge bg-warning">ALTO</span>
                    {% elif r.semaforo == 'BAJO' %}
                      <span class="badge bg-danger">BAJO</span>
                    {% else %}
                      <span class="badge bg-secondary">N/A</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="5" class="text-center py-4 text-muted">Calcula al menos un período actual para ver ratios.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Sección: Comparación con Parámetros de Sector -->
  {% if ratios_sector %}
  <div class="card mb-4">
    <div class="card-header">Comparación con Ratios Digitados por Sector</div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-bordered table-sm m-0">
          <thead class="table-light">
            <tr>
              <th>Ratio</th>
              <th class="text-end">Valor empresa</th>
              <th class="text-end">Parámetro sector</th>
              <th class="text-center">Cumplimiento</th>
            </tr>
          </thead>
          <tbody>
            {% for r in ratios_sector %}
              <tr>
                <td>{{ r.nombre }}</td>
                <td class="text-end">{% if r.valor is not None %}{{ r.valor|floatformat:2 }}{% else %}—{% endif %}</td>
                <td class="text-end">{% if r.valor_sector is not None %}{{ r.valor_sector|floatformat:2 }}{% else %}—{% endif %}</td>
                <td class="text-center">
                  {% if r.semaforo_sector == 'CUMPLE' %}
                    <span class="badge bg-success">CUMPLE</span>
                  {% elif r.semaforo_sector == 'NO_CUMPLE' %}
                    <span class="badge bg-danger">NO CUMPLE</span>
                  {% else %}
                    <span class="badge bg-secondary">N/A</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Sección: Análisis Vertical Estado de Resultados -->
  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>Análisis Vertical Estado de Resultados</span>
      <span class="text-muted small">
        {% if per_base_id %}Comparando Base vs Actual{% else %}Período actual{% endif %}
      </span>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-bordered table-sm m-0">
          <thead class="table-light">
            <tr>
              <th>Cuenta / Línea</th>
              {% if vertical_base_res %}<th class="text-end">Monto Base</th><th class="text-end">% Base</th>{% endif %}
              <th class="text-end">Monto Actual</th>
              <th class="text-end">% Actual</th>
            </tr>
          </thead>
          <tbody>
          {% if vertical_act_res %}
            {% for a in vertical_act_res %}
              {% with b=vertical_base_res|find_by_clave:a.clave %}
              <tr>
                <td>{{ a.nombre }}</td>
                {% if vertical_base_res %}
                  <td class="text-end">{% if b %}{{ b.monto }}{% else %}—{% endif %}</td>
                  <td class="text-end">{% if b %}{{ b.porc|floatformat:2 }}%{% else %}—{% endif %}</td>
                {% endif %}
                <td class="text-end">{{ a.monto }}</td>
                <td class="text-end">{{ a.porc|floatformat:2 }}%</td>
              </tr>
              {% endwith %}
            {% endfor %}
          {% else %}
            <tr><td colspan="5" class="text-center py-4 text-muted">Sin datos aún. Elige una empresa y período.</td></tr>
          {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Sección: Análisis Vertical Balance General -->
  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>Análisis Vertical Balance General</span>
      <span class="text-muted small">
        {% if per_base_id %}Comparando Base vs Actual{% else %}Período actual{% endif %}
      </span>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-bordered table-sm m-0">
          <thead class="table-light">
            <tr>
              <th>Cuenta / Línea</th>
              {% if vertical_base_bal %}<th class="text-end">Monto Base</th><th class="text-end">% Base</th>{% endif %}
              <th class="text-end">Monto Actual</th>
              <th class="text-end">% Actual</th>
            </tr>
          </thead>
          <tbody>
          {% if vertical_act_bal %}
            {% for a in vertical_act_bal %}
              {% with b=vertical_base_bal|find_by_clave:a.clave %}
              <tr>
                <td>{{ a.nombre }}</td>
                {% if vertical_base_bal %}
                  <td class="text-end">{% if b %}{{ b.monto }}{% else %}—{% endif %}</td>
                  <td class="text-end">{% if b %}{{ b.porc|floatformat:2 }}%{% else %}—{% endif %}</td>
                {% endif %}
                <td class="text-end">{{ a.monto }}</td>
                <td class="text-end">{{ a.porc|floatformat:2 }}%</td>
              </tr>
              {% endwith %}
            {% endfor %}
          {% else %}
            <tr><td colspan="5" class="text-center py-4 text-muted">Sin datos aún. Elige una empresa y período.</td></tr>
          {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Sección: Análisis Horizontal Estado de Resultados -->
  <div class="card mb-4">
    <div class="card-header">Análisis Horizontal Estado de Resultados (Base vs Actual)</div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-bordered table-sm m-0">
          <thead class="table-light">
            <tr>
              <th>Cuenta / Línea</th>
              <th class="text-end">Base</th>
              <th class="text-end">Actual</th>
              <th class="text-end">Variación</th>
              <th class="text-end">% Cambio</th>
              <th class="text-center">Tendencia</th>
            </tr>
          </thead>
          <tbody>
          {% if horizontal_rows_res %}
            {% for r in horizontal_rows_res %}
              <tr>
                <td>{{ r.nombre }}</td>
                <td class="text-end">{{ r.base }}</td>
                <td class="text-end">{{ r.actual }}</td>
                <td class="text-end">{{ r.variacion }}</td>
                <td class="text-end">
                  {% if r.porc is not None %}{{ r.porc|floatformat:2 }}%{% else %}—{% endif %}
                </td>
                <td class="text-center">
                  {% if r.porc is not None %}
                    {% if r.porc > 0 %}<span class="badge-dot dot-up"></span>▲
                    {% elif r.porc < 0 %}<span class="badge-dot dot-down"></span>▼
                    {% else %}<span class="badge-dot dot-flat"></span>•
                    {% endif %}
                  {% else %}<span class="badge-dot dot-flat"></span>•
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="6" class="text-center py-4 text-muted">Para ver horizontal necesitas elegir también el período base.</td></tr>
          {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Sección: Análisis Horizontal Balance General -->
  <div class="card mb-4">
    <div class="card-header">Análisis Horizontal Balance General (Base vs Actual)</div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-bordered table-sm m-0">
          <thead class="table-light">
            <tr>
              <th>Cuenta / Línea</th>
              <th class="text-end">Base</th>
              <th class="text-end">Actual</th>
              <th class="text-end">Variación</th>
              <th class="text-end">% Cambio</th>
              <th class="text-center">Tendencia</th>
            </tr>
          </thead>
          <tbody>
          {% if horizontal_rows_bal %}
            {% for r in horizontal_rows_bal %}
              <tr>
                <td>{{ r.nombre }}</td>
                <td class="text-end">{{ r.base }}</td>
                <td class="text-end">{{ r.actual }}</td>
                <td class="text-end">{{ r.variacion }}</td>
                <td class="text-end">
                  {% if r.porc is not None %}{{ r.porc|floatformat:2 }}%{% else %}—{% endif %}
                </td>
                <td class="text-center">
                  {% if r.porc is not None %}
                    {% if r.porc > 0 %}<span class="badge-dot dot-up"></span>▲
                    {% elif r.porc < 0 %}<span class="badge-dot dot-down"></span>▼
                    {% else %}<span class="badge-dot dot-flat"></span>•
                    {% endif %}
                  {% else %}<span class="badge-dot dot-flat"></span>•
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="6" class="text-center py-4 text-muted">Para ver horizontal necesitas elegir también el período base.</td></tr>
          {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const empresaSelect = document.getElementById('empresa-select');
  const periodoBaseSelect = document.getElementById('periodo-base-select');
  const periodoActualSelect = document.getElementById('periodo-actual-select');
  
  // Valores iniciales desde la URL
  const initialEmpresa = '{{ request.GET.nit|default:"" }}';
  const initialPerBase = '{{ request.GET.per_base|default:"" }}';
  const initialPerAct = '{{ request.GET.per_act|default:"" }}';
  
  function cargarPeriodos(empresaId, periodoBaseId = null, periodoActualId = null) {
    if (!empresaId) {
      periodoBaseSelect.innerHTML = '<option value="">-- Opcional --</option>';
      periodoActualSelect.innerHTML = '<option value="">-- Seleccione un período --</option>';
      periodoBaseSelect.disabled = true;
      periodoActualSelect.disabled = true;
      return;
    }
    
    periodoBaseSelect.disabled = true;
    periodoActualSelect.disabled = true;
    periodoBaseSelect.innerHTML = '<option value="">Cargando...</option>';
    periodoActualSelect.innerHTML = '<option value="">Cargando...</option>';
    
    // Cargar períodos que tengan Balance (BAL) - ambos tipos de estado se calculan simultáneamente
    const url = `{% url 'api_get_periodos' %}?empresa_id=${empresaId}&tipo_estado=BAL`;
    
    fetch(url)
      .then(response => response.json())
      .then(data => {
        // Limpiar selectores
        periodoBaseSelect.innerHTML = '<option value="">-- Opcional --</option>';
        periodoActualSelect.innerHTML = '<option value="">-- Seleccione un período --</option>';
        
        if (data.periodos && data.periodos.length > 0) {
          data.periodos.forEach(periodo => {
            const optionBase = document.createElement('option');
            optionBase.value = periodo.id;
            optionBase.textContent = periodo.label;
            if (periodoBaseId && periodo.id == periodoBaseId) {
              optionBase.selected = true;
            }
            periodoBaseSelect.appendChild(optionBase);
            
            const optionActual = document.createElement('option');
            optionActual.value = periodo.id;
            optionActual.textContent = periodo.label;
            if (periodoActualId && periodo.id == periodoActualId) {
              optionActual.selected = true;
            }
            periodoActualSelect.appendChild(optionActual);
          });
          
          periodoBaseSelect.disabled = false;
          periodoActualSelect.disabled = false;
        } else {
          periodoBaseSelect.innerHTML = '<option value="">-- Sin períodos disponibles --</option>';
          periodoActualSelect.innerHTML = '<option value="">-- Sin períodos disponibles --</option>';
        }
      })
      .catch(error => {
        console.error('Error al cargar períodos:', error);
        periodoBaseSelect.innerHTML = '<option value="">-- Error al cargar --</option>';
        periodoActualSelect.innerHTML = '<option value="">-- Error al cargar --</option>';
      });
  }
  
  function actualizarPeriodos() {
    const empresaId = empresaSelect.value;
    cargarPeriodos(empresaId);
  }
  
  // Event listeners
  empresaSelect.addEventListener('change', actualizarPeriodos);
  
  // Cargar períodos iniciales si hay empresa seleccionada
  if (initialEmpresa) {
    cargarPeriodos(initialEmpresa, initialPerBase, initialPerAct);
  }
});
</script>

<!-- Modal para Gráficas de Ratios -->
<div class="modal fade" id="ratiosGraficasModal" tabindex="-1" aria-labelledby="ratiosGraficasModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ratiosGraficasModalLabel">Gráficas de Ratios - Evolución Temporal</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="ratios-charts-container" class="row row-cols-1 row-cols-md-2 g-3">
          <div class="col-12 text-center">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Cargando gráficas...</span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// Función para cargar y renderizar gráficas de ratios
async function cargarGraficasRatios(empresaNit) {
  const container = document.getElementById('ratios-charts-container');
  container.innerHTML = '<div class="col-12 text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Cargando gráficas...</span></div></div>';
  
  try {
    // Validar que haya al menos 3 períodos
    const validationUrl = `{% url 'ratios_graficas_modal' %}?empresa=${empresaNit}`;
    const validationResponse = await fetch(validationUrl);
    const validationData = await validationResponse.json();
    
    if (!validationResponse.ok) {
      container.innerHTML = `<div class="col-12"><div class="alert alert-warning">${validationData.error || 'Error al validar datos'}</div></div>`;
      return;
    }
    
    // Obtener datos de ratios
    const ratiosClaves = validationData.ratios.map(r => r.clave).join(',');
    const dataUrl = `{% url 'ratios_series_json' %}?empresa=${empresaNit}&claves=${ratiosClaves}`;
    const dataResponse = await fetch(dataUrl);
    const data = await dataResponse.json();
    
    if (!dataResponse.ok) {
      container.innerHTML = `<div class="col-12"><div class="alert alert-danger">${data.error || 'Error al cargar datos'}</div></div>`;
      return;
    }
    
    // Limpiar contenedor
    container.innerHTML = '';
    
    // Crear una gráfica por cada ratio
    Object.entries(data.series).forEach(([clave, info]) => {
      const col = document.createElement('div');
      col.className = 'col';
      
      const card = document.createElement('div');
      card.className = 'card shadow-sm';
      
      const cardBody = document.createElement('div');
      cardBody.className = 'card-body';
      
      const title = document.createElement('h6');
      title.className = 'card-title';
      title.textContent = info.nombre;
      cardBody.appendChild(title);
      
      const canvas = document.createElement('canvas');
      cardBody.appendChild(canvas);
      card.appendChild(cardBody);
      col.appendChild(card);
      container.appendChild(col);
      
      // Filtrar valores None
      const valoresFiltrados = info.valores.map((v, i) => v !== null ? {x: i, y: v} : null).filter(v => v !== null);
      const labelsFiltrados = data.anios.filter((_, i) => info.valores[i] !== null);
      
      // Crear gráfica
      new Chart(canvas.getContext('2d'), {
        type: 'line',
        data: {
          labels: data.anios,
          datasets: [{
            label: info.nombre,
            data: info.valores,
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1,
            spanGaps: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              mode: 'index',
              intersect: false
            }
          },
          scales: {
            y: {
              beginAtZero: false
            }
          }
        }
      });
    });
    
    if (container.children.length === 0) {
      container.innerHTML = '<div class="col-12"><div class="alert alert-info">No hay datos suficientes para generar gráficas.</div></div>';
    }
    
  } catch (error) {
    console.error('Error al cargar gráficas:', error);
    container.innerHTML = `<div class="col-12"><div class="alert alert-danger">Error al cargar las gráficas: ${error.message}</div></div>`;
  }
}
</script>
{% endblock content %}
